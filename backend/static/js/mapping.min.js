"use strict";function getCookie(e){var t;if(document.cookie&&document.cookie!==""){var n=document.cookie.split(";");for(var r=0;r<n.length;r++){var i=jQuery.trim(n[r]);if(i.substring(0,e.length+1)===e+"="){t=decodeURIComponent(i.substring(e.length+1));break}}}return t}function csrfSafeMethod(e){return/^(GET|HEAD|OPTIONS|TRACE)$/.test(e)}function getExteriorData(e,t){$("#progressPopup").text("Loading map");$("#progressPopup").popup("open");var n="false";if(n){n="true"}var r="GetExteriorData_c_"+e+"_f_"+t+"_m_"+n;var i=localStorage.getObject(r);if(!i){var s=window.location.protocol+"//"+window.location.hostname+":"+window.location.port;$.ajax({type:"GET",dataType:"json",contentType:"application/json",timeout:3e4,url:s+"/api/exterior/",data:"category="+e+"&flag="+t+"&isMobile="+n,success:function(e){writeExt(r,e,1440)},error:function(e,t,n){alert(t+", "+n)}})}else{drawExternal(i)}}function getInteriorData(e,t,n){$("#progressPopup").text("Loading Interior");$("#progressPopup").popup("open");$("#floor_selector_dropdown").trigger("collapse");var r="GetInteriorData_b_"+e+"_l_"+t;var i=localStorage.getObject(r);if(!i){var s=window.location.protocol+"//"+window.location.hostname+":"+window.location.port;$.ajax({type:"GET",dataType:"json",contentType:"application/json",timeout:3e4,url:s+"/api/interior/",data:"BuildingName="+e+"&Level="+t,success:function(i){writeInt(r,i,1440,e,t);if(n){drawLine(n)}},error:function(e,t,n){alert(t+", "+n)}})}else{drawFloor(i,e,t);if(n){drawLine(n)}}}function queryPath(){$("#progressPopup").text("Finding route");$("#progressPopup").popup("open");console.log("query");var e=getCookie("csrftoken");var t=window.location.protocol+"//"+window.location.host;if(Waypoint.list.length<2){return}$.ajaxSetup({crossDomain:false,beforeSend:function(t,n){if(!csrfSafeMethod(n.type)){t.setRequestHeader("X-CSRFToken",e)}}});$.ajax({type:"POST",dataType:"json",contentType:"application/json",timeout:3e4,url:t+"/api/pathfinding/",data:JSON.stringify(Waypoint.waypoints),success:function(e){console.log(e);if(e.status=="ok"){buildDirections(e.waypoints)}else{alert(e.message);$("#progressPopup").popup("close")}},error:function(e,t,n){alert(t+", "+n);$("#progressPopup").popup("close")}})}function getHistory(){var e="user_history";var t=localStorage.getObject(e);if(!t){t={routes:[],accessibility:false,indoors:5};updateHistory(t)}return t}function updateHistory(e){var t="user_history";try{localStorage.setObject(t,e,525949)}catch(n){if(n.name==="QUOTA_EXCEEDED_ERR"){localStorage.clear();updateHistory(e)}}}function recordRoute(e){var t=getHistory();var n=t.routes;if(n.length>4){n.shift()}n.push(e);updateHistory(t)}function buildHistoricalDirections(e){var t=getHistory();var n=t.routes.reverse();var r=n[e];n.splice(e,1);t.routes=n.reverse();updateHistory(t);buildDirections(r);$("#routehistory").popup("close")}function showRouteHistory(){var e=$("#pastpaths");e.empty();var t=getHistory().routes.reverse();var n=new google.maps.Geocoder;$.each(t,function(t,r){var i=r[0];var s=r[r.length-1];var o='<li data-role="button" data-corners="false" onclick="buildHistoricalDirections('+t+')">';if(i.Key&&i.Level&&i.Lines){var u=data_cache.lookup(i.Key);var a=i.Level;for(var f in u.levels){if(u.levels[f].FloorNumber==i.Level){a=u.levels[f].displayName}}o+='<div class="past_route" id="historyListStart_'+t+'">Start:<br/>';o+=a+" of "+u.displayName+"</div>"}else if(i.Coord){o+='<div class="past_route"  id="historyListStart_'+t+'"></div>';var l=new google.maps.LatLng(i.Coord.lat,i.Coord.lng);n.geocode({latLng:l},function(e,n){var r="Start:<br/>";if(n===google.maps.GeocoderStatus.OK&&e[0]){r+=e[0].formatted_address}else{r+="lat:"+i.Coord.lat+", lng:"+i.Coord.lng}$("#historyListStart_"+t).html(r)})}if(s.Key&&s.Level&&s.Lines){var c=data_cache.lookup(s.Key);var a=s.Level;for(var f in u.levels){if(u.levels[f].FloorNumber==i.Level){a=u.levels[f].displayName}}o+='<div class="past_route" id="historyListEnd_'+t+'">End:<br/>';o+=a+" of "+c.displayName+"</div>"}else if(s.Coord){o+='<div class="past_route" id="historyListEnd_'+t+'"></div>';var h=new google.maps.LatLng(s.Coord.lat,s.Coord.lng);n.geocode({latLng:h},function(e,n){var r="End:<br/>";if(n===google.maps.GeocoderStatus.OK&&e[0]){r+=e[0].formatted_address}else{r+="lat:"+s.Coord.lat+", lng:"+s.Coord.lng}$("#historyListEnd_"+t).html(r)})}o+="</li>";e.append(o)});e.listview("refresh");e.trigger("create");$("#routehistory").popup("open")}function writeExt(e,t,n){try{localStorage.setObject(e,t,n)}catch(r){if(r.name==="QUOTA_EXCEEDED_ERR"){var i=getHistory();localStorage.clear();updateHistory(i)}}drawExternal(t)}function writeInt(e,t,n,r,i){try{localStorage.setObject(e,t,n)}catch(s){if(s.name==="QUOTA_EXCEEDED_ERR"){var o=getHistory();localStorage.clear();updateHistory(o)}}drawFloor(t,r,i)}function drawExternal(e){var t=e.d.Polys;var n=e.d.Labels;var r=e.d.Markers;map.clearOverlays();$.each(t,function(e,t){var n="#"+t.LineColor;var i=t.LineWidth;var s=t.LineTransparency;var o=t.Path;var u=[];$.each(o,function(e,t){var n=t.lat;var r=t.lng;u.push(new google.maps.LatLng(n,r))});var a=new google.maps.Polygon({path:u,strokeColor:n,strokeOpacity:1,strokeWeight:i,fillColor:n,fillOpacity:s,geodesic:true,zIndex:5});if(r.length>0){markersArray.push(a)}if(t.BuildingKey&&t.Campus&&t.PolyCenter){if(!data_cache.containsKey(t.BuildingKey)){data_cache.add(t.BuildingKey,{campus:t.Campus,displayName:t.Name,buildingKey:t.BuildingKey,formerName:t.FormerName,infoWindow:t.infoWindow,position:t.PolyCenter,levels:t.levels,desc:t.Description})}}a.setMap(map);google.maps.event.addListener(a,"click",function(e){showBuildingPopOver(e,t)})});$.each(n,function(e,t){var n=t.Coords.lat;var r=t.Coords.lng;var i=t.Name;var s=mobile?17:16;new MapLabel({map:map,minZoom:s,fontSize:10,position:new google.maps.LatLng(n,r),text:i,zIndex:1})});$.each(r,function(e,t){var n=new google.maps.LatLng(t.Coords.lat,t.Coords.lng);var r={draggable:false,icon:t.IconUrl,visible:true,center:n};var i=new google.maps.Marker({position:n,map:map,title:t.Name});google.maps.event.addListener(i,"click",function(e){showBuildingPopOver(e,t)});google.maps.Map.prototype.clearOverlays=function(){for(var e=0;e<markersArray.length;e++){markersArray[e].setMap(null)}};markersArray.push(i)});$("#progressPopup").popup("close")}function currentLocation(){if(!myloc){myloc=new google.maps.Marker({clickable:false,icon:new google.maps.MarkerImage("//maps.gstatic.com/mapfiles/mobile/mobileimgs2.png",new google.maps.Size(22,22),new google.maps.Point(0,18),new google.maps.Point(11,11)),shadow:null,zIndex:999,map:map})}if(navigator.geolocation){navigator.geolocation.getCurrentPosition(function(e){var t=new google.maps.LatLng(e.coords.latitude,e.coords.longitude);myloc.setPosition(t);map.panTo(t);map.setZoom(16);var n={stop:null,latLng:t};google.maps.event.trigger(map,"click",n)})}}function cordovaGeolocationInit(){if(!myloc){myloc=new google.maps.Marker({clickable:false,icon:new google.maps.MarkerImage("//maps.gstatic.com/mapfiles/mobile/mobileimgs2.png",new google.maps.Size(22,22),new google.maps.Point(0,18),new google.maps.Point(11,11)),shadow:null,zIndex:999,map:map});watchID=navigator.geolocation.watchPosition(function(e){me=new google.maps.LatLng(e.coords.latitude,e.coords.longitude)},function(e){if(watchID!==null){navigator.geolocation.clearWatch(watchID);watchID=null}},{maximumAge:3e3,timeout:5e3,enableHighAccuracy:true})}setTimeout(function(){myloc.setPosition(me);map.panTo(me);map.setZoom(16)},5e3)}function drawFloor(e,t,n){$("#mapCanvas").hide();$("#interiorCanvas").show();$("#interior_controls").show();if(mobile){$("#floor_selector_mobile").show()}else{$("#floor_selector").show()}$("[id^=interior_popup]").hide();$("#interiorCanvas").empty();$("#interiorCanvas").append('<canvas id="interior"></canvas>');UAlberta.Maps.Interior.clearCanvas();UAlberta.Maps.Interior.updateInstance();$("#interior").attr("height",$("#mainContent").height()).attr("width",$("#mainContent").width());UAlberta.Maps.Interior.initialise("interior",{defaultCameraRotation:90,defaultCameraPitch:45,defaultCameraRoll:0,maxFPS:60,buildingName:t,level:n});var r=e.d;$.each(r.Polys,function(e,t){UAlberta.Maps.Interior.addPolygon(t.Path,t.Triangles,t.Options)});$.each(r.Lines,function(e,t){UAlberta.Maps.Interior.addLine(t.Start,t.End,t.Options)});$.each(r.Points,function(e,t){UAlberta.Maps.Interior.addPoint(t.Point,t.Options)});$.each(r.Text,function(e,t){UAlberta.Maps.Interior.addText(t.Text,t.Point,t.Options)});UAlberta.Maps.Interior.camera.centerCamera(false);UAlberta.Maps.Interior.render(true);$("#progressPopup").popup("close")}function focusSubPath(e){var t=global_path[e];if(t.Coord&&t.Coord.lat&&t.Coord.lng){var n=UAlberta.Maps.Interior;$("#interiorCanvas").hide();$("#interior_controls").hide();$("#floor_selector").hide();$("#floor_selector_mobile").hide();n.clearCanvas();if(infowindow){infowindow.close()}map.clearOverlays();map.panTo(new google.maps.LatLng(t.Coord.lat,t.Coord.lng));map.setZoom(19);$("#directions_naviagation_info").attr("onclick","navCurrent("+e+");");$("#directions_naviagation_back").attr("onclick","navBack("+(e-1)+");");if(e===0){$("#directions_naviagation_back").css("opacity","0.2")}else{$("#directions_naviagation_back").css("opacity","1")}$("#directions_naviagation_fwd").attr("onclick","navFwd("+(e+1)+");");if(e===nav_path.length-1){$("#directions_naviagation_fwd").css("opacity","0.2")}else{$("#directions_naviagation_fwd").css("opacity","1")}$("#directions_naviagation_info").text(nav_path[e]);$("#directions_naviagation_info").trigger("create");$("#mapCanvas").show()}}function drawLine(e){var t={lineColor:"#FF0000",lineThickness:3};var n=UAlberta.Maps.Interior;var r={x:e.Lines[0].x,y:10,z:e.Lines[0].z};n.addImage("static/css/img/marker_greenA.png",r,20,34,t);$.each(e.Lines,function(r,i){var s=i;var o=e.Lines[r+1];if(o){n.addLine(s,o,t)}});var i={x:e.Lines[e.Lines.length-1].x,y:10,z:e.Lines[e.Lines.length-1].z};n.addImage("static/css/img/marker_greenB.png",i,20,34,t);n.render(true);setTimeout(n.render,200)}function drawExtPath(e){var t=[];if(infowindow){infowindow.close()}map.clearOverlays();$.each(e,function(e,n){if(n.Coord){t.push(n.Coord)}else{getExtRoute(t);t=[]}});getExtRoute(t)}function getExtRoute(e){if(e.length>1){var t=window.google.maps;var n=new t.DirectionsRenderer,r=t.TravelMode.WALKING,i=new t.DirectionsService,s=e.length,o=[],u=new google.maps.LatLng(e[0].lat,e[0].lng),a=new google.maps.LatLng(e[s-1].lat,e[s-1].lng);n.setMap(map);directionsDisplay.push(n);if(s>2){for(var f=1;f<s-2;f++){o.push({location:google.maps.LatLng(e[f].lat,e[f].lng),stopover:true})}}var l={origin:u,waypoints:o,destination:a,travelMode:r};i.route(l,function(e,r){if(r===t.DirectionsStatus.OK){n.setDirections(e)}})}}function drawSubPath(e){var t=global_path[e];if(t){if(t.Key&&t.Level&&t.Lines){UAlberta.Maps.Exterior.launchInterior(t.Key,t.Level,"",t);$("#directions_naviagation_info").attr("onclick","navCurrent("+e+");");$("#directions_naviagation_back").attr("onclick","navBack("+(e-1)+");");if(e===0){$("#directions_naviagation_back").css("opacity","0.2")}else{$("#directions_naviagation_back").css("opacity","1")}$("#directions_naviagation_fwd").attr("onclick","navFwd("+(e+1)+");");if(e===nav_path.length-1){$("#directions_naviagation_fwd").css("opacity","0.2")}else{$("#directions_naviagation_fwd").css("opacity","1")}$("#directions_naviagation_info").text(nav_path[e]);$("#directions_naviagation_info").trigger("create")}}}function clearDirections(){var e=UAlberta.Maps.Interior;$("#interiorCanvas").hide();$("#interior_controls").hide();$("#floor_selector").hide();$("#floor_selector_mobile").hide();e.clearCanvas();if(map){map.setZoom(16);map.clearOverlays()}if(directionsDisplay){$.each(directionsDisplay,function(e,t){t.setMap(null)})}directionsDisplay=[];$("#directions_naviagation").css("display","none");$("#mapCanvas").css("bottom","0em");$("#interiorCanvas").css("bottom","0em");$("#mapCanvas").show();global_path=[];nav_path=[];var t=$("#directionsList");t.empty();t.append('<li><a href="#" ><div style="white-space:normal;">No directions loaded</div></a></li>');t.listview("refresh")}function buildDirections(e){global_path=e;recordRoute(e);var t=$("#directionsList");var n=new google.maps.Geocoder;t.empty();$.each(global_path,function(e,r){nav_path.push(e);var i="";if(r.Key&&r.Level&&r.Lines){var s=data_cache.lookup(r.Key);var o=r.Level;for(var u in s.levels){if(s.levels[u].FloorNumber==r.Level){o=s.levels[u].displayName}}var a=o+" of "+s.displayName;i+='<li id="dirList_'+e+'"><a href="#" onclick="drawSubPath('+e+')" >';i+='<div id="directions_'+e+'" style="white-space:normal;">';i+=a;nav_path[e]=a}else if(r.Coord){var f=new google.maps.LatLng(r.Coord.lat,r.Coord.lng);i+='<li id="dirList_'+e+"\"><a href='#' onclick=\"focusSubPath("+e+')" >';i+='<div id="directions_'+e+'" style="white-space:normal;">';n.geocode({latLng:f},function(t,n){var i;if(n===google.maps.GeocoderStatus.OK&&t[0]){i=t[0].formatted_address}else{i="Lat:"+r.Coord.lat+", Lng:"+r.Coord.lng}$("#directions_"+e).text(i);$("#directions_"+e).trigger("create");nav_path[e]=i})}i+="</div></a></li>";t.append(i)});t.listview("refresh");drawExtPath(global_path);$("#directionsCollapsible").trigger("expand");$("#campusSelectCollapse").trigger("collapse");$("#createPathDropDown").trigger("collapse");$("#createPathDropDown").trigger("collapse");$("#progressPopup").popup("close");location.hash="#directionsCollapsible";$("#directionsCollapsible ul li a").click(function(){$("#directionsCollapsible ul li a").each(function(){var e=$(this).parent();$(e).removeClass("ui-btn-active")});var e=$(this).parent();$(e).addClass("ui-btn-active")});$("#directions_naviagation").css("display","inline");$("#mapCanvas").css("bottom","2.813em");$("#interiorCanvas").css("bottom","2.813em");$("#directions_naviagation_info").text(nav_path[0]);$("#directions_naviagation_info").trigger("create");$("#directions_naviagation_info").attr("onclick","navCurrent(0);");$("#directions_naviagation_back").attr("onclick","navBack(-1);");$("#directions_naviagation_back").css("opacity","0.2");if(global_path.length<2){$("#directions_naviagation_fwd").css("opacity","0.2")}else{$("#directions_naviagation_fwd").css("opacity","1")}$("#directions_naviagation_fwd").attr("onclick","navFwd(1);");$("#dirList_0 a").trigger("click");if(mobile){$("#sidebar").panel("close")}}function navBack(e){if(e<0){return}$("#dirList_"+e+" a").trigger("click")}function navFwd(e){if(e>global_path.length){return}$("#dirList_"+e+" a").trigger("click")}function navCurrent(e){$("#dirList_"+e+" a").trigger("click")}function appendToBuildingsList(){var e=[];for(var t=0;t<data_cache.length();t++){var n=data_cache.lookup(data_cache.lookupKey(t));e.push('<li><a href="javascript:void(0);" onclick="buildingListClick('+t+');"><div style="white-space:normal;">'+n.displayName+"</div></a></li>")}e.sort(function(e,t){var n=$(e).text(),r=$(t).text();if(n<r){return-1}if(n>r){return 1}return 0});$("#buildingSelection").empty();$.each(e,function(e,t){$("#buildingSelection").append(t)});$("#buildingSelection").listview("refresh")}function buildingListClick(e){$("#interior_controls").hide();$("#floor_selector").hide();$("#floor_selector_mobile").hide();$("#mapCanvas").show();var t=data_cache.lookup(data_cache.lookupKey(e));var n=t.position.lat;var r=t.position.lng;var i={Description:t.desc};var s={stop:null,latLng:new google.maps.LatLng(n,r)};showBuildingPopOver(s,i);if(mobile){$("#sidebar").panel("close")}}function MapLabel(e){this.set("fontFamily","sans-serif");this.set("fontSize",12);this.set("fontColor","#000000");this.set("strokeWeight",4);this.set("strokeColor","#ffffff");this.set("align","center");this.set("zIndex",1e3);this.setValues(e)}function toMultiLine(e){var t=new Array;e=e.replace(/\n\r?/g,"<br/>");t=e.split("<br/>");return t}var data_cache=new Dictionary;var global_path=[];var nav_path=[];var me;var myloc;var watchID=null;var directionsDisplay=[];var markersArray=[];Storage.prototype.setObject=function(e,t,n){var r=n*60*1e3;var i={value:JSON.stringify(t),timestamp:(new Date).getTime()+r};this.setItem(e,JSON.stringify(i))};Storage.prototype.getObject=function(e){var t=JSON.parse(this.getItem(e));if(!t){return false}if((new Date).getTime()>t.timestamp){return false}return JSON.parse(t.value)};MapLabel.prototype=new google.maps.OverlayView;window["MapLabel"]=MapLabel;MapLabel.prototype.changed=function(e){switch(e){case"fontFamily":case"fontSize":case"fontColor":case"strokeWeight":case"strokeColor":case"align":case"text":return this.drawCanvas_();case"maxZoom":case"minZoom":case"position":return this.draw()}};MapLabel.prototype.drawCanvas_=function(){var e=this.canvas_;if(!e)return;var t=e.style;t.zIndex=this.get("zIndex");var n=e.getContext("2d");n.clearRect(0,0,e.width,e.height);n.strokeStyle=this.get("strokeColor");n.fillStyle=this.get("fontColor");n.font=this.get("fontSize")+"px"+this.get("fontFamily");var r=Number(this.get("strokeWeight"));var i=this.get("text");if(i){var s=toMultiLine(i);var o="";var u=this.get("fontSize");var a=u+3;for(var f=0;s.length>f;f++){if(s[f].length>o.length){o=s[f]}if(r){n.lineWidth=r;n.strokeText(s[f],r,a)}n.fillText(s[f],r,a);a+=u}var l=n.measureText(o);var c=l.width+r;t.marginLeft=this.getMarginLeft_(c)+"px";t.marginTop=s.length*-.4+"em"}};MapLabel.prototype.onAdd=function(){var e=this.canvas_=document.createElement("canvas");var t=e.style;t.position="absolute";var n=e.getContext("2d");n.lineJoin="round";n.textBaseline="top";this.drawCanvas_();var r=this.getPanes();if(r){r.overlayImage.appendChild(e)}};MapLabel.prototype["onAdd"]=MapLabel.prototype.onAdd;MapLabel.prototype.getMarginLeft_=function(e){switch(this.get("align")){case"left":return 0;case"right":return-e}return e/-2};MapLabel.prototype.draw=function(){var e=this.getProjection();if(!e){return}if(!this.canvas_){return}var t=this.get("position");if(!t){return}var n=e.fromLatLngToDivPixel(t);var r=this.canvas_.style;var i=map.getZoom();r["top"]=n.y+"px";r["left"]=n.x+"px";r["visibility"]=this.getVisible_()};MapLabel.prototype["draw"]=MapLabel.prototype.draw;MapLabel.prototype.getVisible_=function(){var e=this.get("minZoom");var t=this.get("maxZoom");if(e===undefined&&t===undefined){return""}var n=this.getMap();if(!n){return""}var r=n.getZoom();if(r<e||r>t){return"hidden"}return""};MapLabel.prototype.onRemove=function(){var e=this.canvas_;if(e&&e.parentNode){e.parentNode.removeChild(e)}};MapLabel.prototype["onRemove"]=MapLabel.prototype.onRemove