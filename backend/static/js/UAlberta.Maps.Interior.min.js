var UAlberta=UAlberta!==undefined?UAlberta:{};UAlberta.Maps=UAlberta.Maps!==undefined?UAlberta.Maps:{};UAlberta.Maps.Interior=function(e,t){"use strict";function N(e,u){r=t("#"+e).first();i=r.offset();n=document.getElementById(e).getContext("2d");s=r.width();o=r.height();w.offsetX=s/2;w.offsetY=o/2;if(n){f=true}if(u){if(u.defaultCameraRotation){w.defaultCameraRotation=x.roundNumber(u.defaultCameraRotation*(Math.PI/180),2)}if(u.defaultCameraPitch){w.defaultCameraPitch=-x.roundNumber(u.defaultCameraPitch*(Math.PI/180),2)}if(u.defaultCameraRoll){w.defaultCameraRoll=x.roundNumber(u.defaultCameraRoll*(Math.PI/180),2)}if(u.maxFPS){p=x.roundNumber(1e3/u.maxFPS,2)}if(u.buildingName){d=u.buildingName}if(u.level){v=u.level}if(u.isMobile!=undefined){g=u.isMobile}}var a=document.getElementById(e);if(c){a.addEventListener("touchstart",S.touchStart);a.addEventListener("touchmove",S.touchMove);a.addEventListener("touchend",S.touchEnd);a.addEventListener("touchcancel",S.touchEnd);t("#interior_conrtols_panUp > a").click(function(){w.controlPanCameraY(-10)});t("#interior_conrtols_panDown > a").click(function(){w.controlPanCameraY(10)});t("#interior_conrtols_panleft > a").click(function(){w.controlPanCameraX(-10)});t("#interior_conrtols_panRight > a").click(function(){w.controlPanCameraX(10)});t("#interior_conrtols_rotateLeft > a").click(function(){w.controlRotateCamera(-.02)});t("#interior_conrtols_rotateRight > a").click(function(){w.controlRotateCamera(.02)});t("#interior_conrtols_ZoomIn > a").click(function(){w.controlZoomCamera(-50)});t("#interior_conrtols_ZoomOut > a").click(function(){w.controlZoomCamera(50)})}else{r.mousedown(E.mouseDown);r.mouseup(E.mouseUp);r.mousemove(E.mouseMove);a.addEventListener("mousewheel",E.mouseWheel);a.addEventListener("DOMMouseScroll",E.mouseWheel);E.mouseHold("interior_conrtols_panUp > a",w.controlPanCameraY,-10,100,1);E.mouseHold("interior_conrtols_panDown > a",w.controlPanCameraY,10,100,1);E.mouseHold("interior_conrtols_panleft > a",w.controlPanCameraX,-10,100,1);E.mouseHold("interior_conrtols_panRight > a",w.controlPanCameraX,10,100,1);E.mouseHold("interior_conrtols_rotateLeft > a",w.controlRotateCamera,-.02,100,1.2);E.mouseHold("interior_conrtols_rotateRight > a",w.controlRotateCamera,.02,100,1.2);E.mouseHold("interior_conrtols_ZoomIn > a",w.controlZoomCamera,-10,100,1.1);E.mouseHold("interior_conrtols_ZoomOut > a",w.controlZoomCamera,10,100,1.1)}}function C(){if(r){i=r.offset();s=r.width();o=r.height()}w.offsetX=s/2;w.offsetY=o/2}function k(e){if(!f){return}var t=(new Date).getTime()-m;if(t<p&&!e){return}x.startTimer();n.width=s;n.fillStyle="#f5f5f5";n.fillRect(0,0,s,o);var r=[],i=u.length;while(i--){u[i].update();r.push.apply(r,u[i].getRenderItems())}r.sort(function(e,t){return e.zIndex-t.zIndex});var l=[];for(i=0;i<r.length;i++){var c="z"+r[i].zIndex,h=r[i].color;if(l[c]==undefined){l[c]=[]}if(l[c][h]==undefined){l[c][h]=[r[i]]}else{l[c][h].push(r[i])}}for(var d in l){for(i in l[d]){if(!l[d][i].length){continue}n.strokeStyle=i;n.fillStyle=i;var v=l[d][i];for(var g=0;g<v.length;g++){switch(v[g].drawType){case a.triangle:if(v[g].points[0]==null||v[g].points[1]==null||v[g].points[2]==null){continue}n.lineWidth=v[g].thick;n.beginPath();n.moveTo(v[g].points[0].x,v[g].points[0].y);n.lineTo(v[g].points[1].x,v[g].points[1].y);n.lineTo(v[g].points[2].x,v[g].points[2].y);n.fill();break;case a.line:if(v[g].points[0]==null||v[g].points[1]==null){continue}n.lineWidth=v[g].thick;n.beginPath();n.moveTo(v[g].points[0].x,v[g].points[0].y);n.lineTo(v[g].points[1].x,v[g].points[1].y);n.stroke();break;case a.point:if(v[g].points[0]==null){continue}n.lineWidth=v[g].thick;n.fillRect(v[g].points[0].x-v[g].thick/2,v[g].points[0].y-v[g].thick/2,v[g].thick,v[g].thick);break;case a.polygon:if(v[g].points[0]==null){continue}n.lineWidth=v[g].thick;n.beginPath();n.moveTo(v[g].points[0].x,v[g].points[0].y);for(var y=1;y<v[g].points.length;y++){if(v[g].points[y]==null){continue}n.lineTo(v[g].points[y].x,v[g].points[y].y)}n.fill();break;case a.text:if(v[g].points[0]==null){continue}n.font=v[g].font;n.strokeStyle="#FFFFFF";n.strokeText(v[g].text,v[g].points[0].x,v[g].points[0].y+1);n.fillText(v[g].text,v[g].points[0].x,v[g].points[0].y);break;case a.image:n.lineWidth=0;if(v[g].points[0]==null){continue}for(var b=0;b<v[g].transforms.length;b++){var w=v[g].transforms[b];n.save();n.beginPath();n.moveTo(w.points[0].x,w.points[0].y);n.lineTo(w.points[1].x,w.points[1].y);n.lineTo(w.points[2].x,w.points[2].y);n.closePath();n.clip();n.transform(w.delta_a/w.delta,w.delta_b/w.delta,w.delta_c/w.delta,w.delta_d/w.delta,w.delta_e/w.delta,w.delta_f/w.delta);n.drawImage(v[g].img,0,0);n.restore()}break;case a.image_2D:n.save();n.drawImage(v[g].img,v[g].points[0].x,v[g].points[0].y,v[g].width,v[g].height);n.restore();break;default:break}}}}x.renderCompass();m=(new Date).getTime()}function L(){if(n){n.width=s;n.fillStyle="#F2F2F2";n.fillRect(0,0,s,o);k()}u=[];m=0;l=null}function A(e,t){t=t!=undefined?t:{};var n=e.x!=undefined?e.x:0,r=e.y!=undefined?e.y:0,i=e.z!=undefined?e.z:0,s=t.fillColor!=undefined?t.fillColor:"#000000",o=2,u=x.transform2D(n,r,i);this.getType=function(){return a.point};this.getBoundingBox=function(){return{min:{x:u.x-1,y:u.y-1,z:u.z-1},max:{x:u.x+1,y:u.y+1,z:u.z+1}}};this.getRenderItems=function(){return[{drawType:a.point,zIndex:x.getZIndex([u]),color:s,thick:o,points:[u]}]};this.update=function(){u=x.transform2D(n,r,i)}}function O(e,t,n){n=n!=undefined?n:{};var r=e!=null||undefined?e:{x:0,y:0,z:0},i=t!=null||undefined?t:{x:0,y:0,z:0},s=n.lineColor!=undefined?n.lineColor:"#000000",o=n.lineThickness!=undefined?n.lineThickness:1,u=x.transform2D(r.x,r.y,r.z),f=x.transform2D(i.x,i.y,i.z);this.getType=function(){return a.line};this.getBoundingBox=function(){var e=r.x,t=r.y,n=r.z,s=r.x,o=r.y,u=r.z;if(i.x>e){e=i.x}else{s=i.x}if(i.y>t){t=i.y}else{o=i.y}if(i.z>n){n=i.z}else{u=i.z}return{min:{x:s,y:o,z:u},max:{x:e,y:t,z:n}}};this.getRenderItems=function(){return[{drawType:a.line,zIndex:x.getZIndex([u,f]),color:s,thick:o,points:[u,f]}]};this.update=function(){u=x.transform2D(r.x,r.y,r.z);f=x.transform2D(i.x,i.y,i.z)}}function M(e,n,r){r=r!=undefined?r:{};r.metaData=r.metaData!=undefined?r.metaData:{};r.metaData.name=r.metaData.name!=undefined?r.metaData.name:"";n=n!=undefined?n:[];var u=e,f=[],l=n,c=[],h=r.lineColor!=undefined?r.lineColor:"#000000",p=r.lineThickness!=undefined?r.lineThickness:1,m=r.fillColor!=undefined?r.fillColor:"#FFFFFF",g=r.wireframe!=undefined?r.wireframe:false,y=r.showEdges!=undefined?r.showEdges:false,b=r.showFill!=undefined?r.showFill:true,E="#6CB800",S=r.image!=undefined?r.image:null,T={min:{x:0,y:0,z:0},max:{x:0,y:0,z:0}},N=r.disableExtrusion!=undefined?r.disableExtrusion:false,C=false,k=[],L=r.metaData;if(S!=null){S.img=new Image;S.src=S.src!=undefined?S.src:"";S.img.src=S.src;S.width=S.width!=undefined?S.width:0;S.height=S.height!=undefined?S.height:0;S.topLeft=S.topLeft!=undefined?S.topLeft:0;S.show=true}this.getType=function(){return a.polygon};this.getBoundingBox=function(){return T};this.update=function(){var e=null,t=null,n=null,r=null,i=null,s=null;f=[];for(var o=0;o<u.length;o++){var a=x.transform2D(u[o].x,u[o].y,u[o].z);f.push(a);if(a==null){continue}if(e==null||a.x>e){e=a.x}if(r==null||a.x<r){r=a.x}if(t==null||a.y>t){t=a.y}if(i==null||a.y<i){i=a.y}if(n==null||a.z>n){n=a.z}if(s==null||a.z<s){s=a.z}}T={min:{x:r,y:i,z:s},max:{x:e,y:t,z:n}};if(S!=null&&u.length==4&&S.show){S.transforms=[];var h=[[S.topLeft,(S.topLeft+1)%4,(S.topLeft+2)%4],[(S.topLeft+2)%4,(S.topLeft+3)%4,S.topLeft]],p=[[{u:0,v:0},{u:S.width,v:0},{u:S.width,v:S.height}],[{u:S.width,v:S.height},{u:0,v:S.height},{u:0,v:0}]];for(var d=0;d<h.length;d++){var v=h[d];var m=p[d];var g=f[v[0]].x,y=f[v[1]].x,b=f[v[2]].x;var w=f[v[0]].y,E=f[v[1]].y,N=f[v[2]].y;var C=m[0].u,k=m[1].u,L=m[2].u;var A=m[0].v,O=m[1].v,M=m[2].v;S.transforms.push({points:[{x:g,y:w},{x:y,y:E},{x:b,y:N}],delta:C*O+A*L+k*M-O*L-A*k-C*M,delta_a:g*O+A*b+y*M-O*b-A*y-g*M,delta_b:w*O+A*N+E*M-O*N-A*E-w*M,delta_c:C*y+g*L+k*b-y*L-g*k-C*b,delta_d:C*E+w*L+k*N-E*L-w*k-C*N,delta_e:C*O*b+A*y*L+g*k*M-g*O*L-A*k*b-C*y*M,delta_f:C*O*N+A*E*L+w*k*M-w*O*L-A*k*N-C*E*M})}}c=[];for(var o=0;o<l.length;o++){var _=f[l[o][0]],D=f[l[o][1]],P=f[l[o][2]];if(_!=null&&D!=null&&P!=null){var H=x.roundNumber((_.z+D.z+P.z)/3,2);c.push({a:_,b:D,c:P,z:H})}}this.updateBubble()};this.getRenderItems=function(){var e=[];if(b){if(c.length==0){e.push({drawType:a.polygon,zIndex:x.getZIndex(f),color:m,thick:1,points:f})}else{for(var n=0;n<c.length;n++){e.push({drawType:a.triangle,zIndex:c[n].z,color:m,thick:1,points:[c[n].a,c[n].b,c[n].c]})}}}if(y||g){for(var n=0;n<f.length;n++){var r=(n+1)%f.length;e.push({drawType:a.line,zIndex:x.getZIndex([f[n],f[r]]),color:h,thick:p,points:[f[n],f[r]]})}}if(S!=null&&S.show){e.push({drawType:a.image,zIndex:x.getZIndex(f),img:S.img,transforms:S.transforms,points:[f[S.topLeft]]})}if(L.showLabel){var i=L.name=="E"?"Entrance":L.name;t("body").append("<span id='tempTextWidth' style='visibility: hidden;height:auto;width:auto;font:bold 12px arial'>"+i+"</span>");var s=t("#tempTextWidth").width(),o={x:(T.min.x+T.max.x-s)/2,y:(T.min.y+T.max.y-12)/2,z:(T.min.z+T.max.z)/2};e.push({drawType:a.text,zIndex:5,color:"#000000",font:"bold 12px arial",text:i,points:[o]});t("#tempTextWidth").remove()}if(C){for(var n=0;n<k.length;n++){k[n].update();e.push.apply(e,k[n].getRenderItems())}}return e};this.pointInPoly=function(e){if(e.x>T.min.x&&e.x<T.max.x&&e.y>T.min.y&&e.y<T.max.y){var t,n=f.length-1,r=false;for(t=0;t<f.length;t++){if(f[t]!=null&&f[n]!=null&&(f[t].y<e.y&&f[n].y>=e.y||f[n].y<e.y&&f[t].y>=e.y)){if(f[t].x+(e.y-f[t].y)/(f[n].y-f[t].y)*(f[n].x-f[t].x)<e.x){r=!r}}n=t}return r}return false};this.extrudeEdges=function(e){if(N){return}if(C){return}var t=[],n,r=[];var i={max:{x:u[0].x,z:u[0].z},min:{x:u[0].x,z:u[0].z}};for(n=0;n<u.length;n++){var a=(n+1)%u.length;t.push({start:u[n],end:u[a]});if(u[n].x>i.max.x){i.max.x=u[n].x}if(u[n].x<i.min.x){i.min.x=u[n].x}if(u[n].z>i.max.z){i.max.z=u[n].z}if(u[n].z<i.min.z){i.min.z=u[n].z}r.push({x:u[n].x,y:u[n].y+e,z:u[n].z})}var f=null;if(S!=null){S.show=false;f={src:S.src,width:S.width,height:S.height,topLeft:S.topLeft}}var c=new M(r,l,{lineColor:h,lineThickness:p,fillColor:E,wireFrame:g,showEdges:y,image:f});c.update();for(n=0;n<t.length;n++){var d=[];d.push(t[n].start);d.push(t[n].end);d.push({x:t[n].end.x,y:t[n].end.y+e,z:t[n].end.z});d.push({x:t[n].start.x,y:t[n].start.y+e,z:t[n].start.z});var v=new M(d,[],{lineColor:h,lineThickness:p,fillColor:E,wireFrame:g,showEdges:y});v.update();k.push(v)}k.push(c);C=true;var i={x:(T.max.x+T.min.x)/2-s/2,y:(T.max.y+T.min.y)/2-o/2};w.centerCamera;w.panCameraY(i.y*-1);w.panCameraX(i.x*-1);this.buildBubble()};this.clearExtrusion=function(){var e=false;if(k.length>0){e=true}C=false;k=[];if(L.popupId!=undefined&&L.popupId!=""){t("#interior_popup"+L.popupId).remove();L.popupId=""}if(S!=null){S.show=true}return e};this.getMetadata=function(){return L};this.buildBubble=function(){if(C){L.popupId=L.name.replace(/ /g,"").replace(/'/gi,"");+(new Date).getTime();var e=document.createElement("DIV");e.style.position="absolute";e.style.zIndex=999;var n=L.popupId;var r=n.replace(/'/gi,"");e.id="interior_popup"+r;var i=document.createElement("DIV");i.style.overflowX="hidden";i.style.overflowY="hidden";i.style.cursor="default";i.style.clear="both";i.style.position="relative";i.style.backgroundColor="#FFFFFF";i.style.borderColor="#CCCCCC";i.style.borderStyle="solid";i.style.borderRadius=i.style.MozBorderRadius=i.style.webkitBorderRadius="10px";i.style.borderWidth="1px";i.style.padding="5px";i.style.whiteSpace="nowrap";i.id="interior_popup_contContain";var s=document.createElement("DIV");s.innerHTML=L.description;i.appendChild(s);var o=document.createElement("DIV");o.style.marginLeft="5px";o.style.marginRight="5px";o.innerHTML="<a href='#' id='addRoute'><i></i><br/>Add as<br/>waypoint</a>";o.href="#";o.onclick=function(){var e={Room:{name:L.name,parent:{Key:d,Level:v,Name:data_cache.lookup(d).displayName}}};Waypoint.addPoint(e);updateCreatePathFieldFrom("Room");t("#progressPopup").text("Added room to the route");t("#progressPopup").popup("open")};o.id="interior_popup_addWaypoint";i.appendChild(o);var u=document.createElement("DIV");u.style.position="relative";u.style.marginTop="-1px";var a=document.createElement("DIV");var f=document.createElement("DIV");a.style.position="absolute";a.style.left="50%";a.style.height="0";a.style.width="0";a.style.marginLeft="-15px";a.style.borderWidth="15px";a.style.borderBottomWidth=0;a.style.borderTopWidth="15px";a.style.borderLeftWidth="15px";a.style.borderRightWidth="15px";a.style.borderColor="#CCCCCC transparent transparent";a.style.borderStyle="solid";f.style.position="absolute";f.style.left="50%";f.style.height="0";f.style.width="0";f.style.marginLeft="-15px";f.style.borderRightWidth="14px";f.style.borderLeftWidth="14px";f.style.borderTopWidth="14px";f.style.borderColor="#FFFFFF transparent transparent";f.style.borderStyle="solid";e.appendChild(i);u.appendChild(a);u.appendChild(f);e.appendChild(u);t("#interiorCanvas").append(e);this.updateBubble()}};this.updateBubble=function(){if(C){var e=L.popupId;var n=e.replace(/'/gi,"");var r={x:(T.max.x+T.min.x)/2-t("#interior_popup"+n).width()/2,y:(T.max.y+T.min.y-100)/2-t("#interior_popup"+n).height()+i.top};t("#interior_popup"+n).css("top",r.y+"px").css("left",r.x+"px")}}}function _(e,t,r){r=r!=undefined?r:{};var i=e,s=t!=undefined?t:{x:0,y:0,z:0},o={},u=r.fontStyle!=undefined?r.fontStyle:"arial",f=r.fontSize!=undefined?r.fontSize:"12px",l=r.fontWeight!=undefined?r.fontWeight:"",c=r.fontColor!=undefined?r.fontColor:"#000000";this.getType=function(){return a.text};this.getBoundingBox=function(){return{min:{x:o.x,y:o.y,z:o.z},max:{x:o.x+n.measureText(i).width,y:o.y,z:o.z}}};this.update=function(){o=x.transform2D(s.x,s.y,s.z)};this.getRenderItems=function(){return[{drawType:a.text,zIndex:o==null?0:o.z,color:c,font:l+" "+f+" "+u,text:i,points:[o]}]}}function D(e,t,n,r,i){i=i!=undefined?i:{};var s=e,o=t!=undefined?t:{x:0,y:0,z:0},u={x:0,y:0,z:0},f=n!=undefined?n:24,l=r!=undefined?r:24,c={min:{x:0,y:0,z:0},max:{x:0,y:0,z:0}};this.getType=function(){return a.image};this.getBoundingBox=function(){return c};this.update=function(){u=x.transform2D(o.x,o.y,o.z);u.x=u.x-f/2;u.y=u.y-l/2;c={min:{x:u.x,y:u.y+l,z:u.z},max:{x:u.x+f,y:u.y,z:u.z}}};this.getRenderItems=function(){var e=new Image;e.src=s;return[{drawType:a.image_2D,zIndex:u==null?0:u.z,img:e,width:f,height:l,points:[u]}]}}function P(e,t){u.push(new A(e,t))}function H(e,t,n){u.push(new O(e,t,n))}function B(e,t,n){u.push(new M(e,t,n))}function j(e,t,n){u.push(new _(e,t,n))}function F(e,t,n,r,i){u.push(new D(e,t,n,r,i))}function I(e,n,r,i,s){UAlberta.Maps.Exterior.loadingBarToggle(true,r);t(".leftNav_interior_buildingImage").html("");t.ajax({type:"POST",url:T.hostUrl,dataType:"json",contentType:"application/json",timeout:T.timeout,data:T.toJSON({BuildingName:e,Level:n}),success:function(e){T.ajaxSuccess(e,r,i);if(s!=undefined){q(s)}},error:function(){T.ajaxError(r)}})}function q(e){for(var t=0;t<u.length;t++){if(u[t].getType()==a.polygon){var n=u[t],r=n.getMetadata();if(r.name==e){n.extrudeEdges(50)}else{n.clearExtrusion()}}}k(true)}function R(e,t){w.rZ=b;var n=.025,r=(t-w.offsetZ)/((e-w.rZ)/n),i=setInterval(function(){if(e&&w.rZ<e){w.rotateCamera(n)}if(t&&w.offsetZ<t){w.zoomCamera(r)}k();if(w.rZ>=e&&w.offsetZ>=t){clearInterval(i)}},p+10)}var n,r,i,s=0,o=0,u=[],a={point:1,line:2,polygon:3,triangle:4,text:5,image:6,image_2D:7,circle:8},f=false,l,c="ontouchstart"in window,h=true,p=33,d,v,m=0,g=false,y=Math.PI*2,b=Math.PI/2,w={rX:0,rY:Math.PI,rZ:0,depth:1e3,offsetX:0,offsetY:0,offsetZ:1e3,defaultCameraRotation:0,defaultCameraPitch:0,defaultCameraRoll:0,zoomBounds:{zIn:-500,zOut:1e3},pitchBounds:{bottom:-.35,top:-b},zoomCamera:function(e){w.setCameraZoom(w.offsetZ+e)},panCameraX:function(e){w.setCameraPanX(w.offsetX+e)},panCameraY:function(e){w.setCameraPanY(w.offsetY+e)},rotateCamera:function(e){w.setCameraRotationZ(w.rZ+e)},pitchCamera:function(e){w.setCameraRotationX(w.rX+e)},rollCamera:function(e){w.setCameraRotationY(w.rY+e)},setCameraZoom:function(e){if(!isNaN(e)){if(e>w.zoomBounds.zOut){e=w.zoomBounds.zOut}if(e<w.zoomBounds.zIn){e=w.zoomBounds.zIn}w.offsetZ=Math.round(e)}else{t.error("Zoom amount is a non-number. Function: UAlberta.Maps.Interior.camera.zoomCamera(amount)")}},setCameraPanX:function(e){if(!isNaN(e)){w.offsetX=Math.round(e)}else{t.error("Pan X amount is a non-number. Function: UAlberta.Maps.Interior.camera.panCameraX(amount)")}},setCameraPanY:function(e){if(!isNaN(e)){w.offsetY=Math.round(e)}else{t.error("Pan Y amount is a non-number. Function: UAlberta.Maps.Interior.camera.panCameraY(amount)")}},setCameraRotationX:function(e){if(!isNaN(e)){if(e<=w.pitchBounds.bottom&&e>=w.pitchBounds.top){w.rX=x.roundNumber(e,2)}}else{t.error("Pitch amount is a non-number. Function: UAlberta.Maps.Interior.camera.pitchCamera(amount)")}},setCameraRotationY:function(e){if(!isNaN(e)){w.rY=x.roundNumber(e,2)}else{t.error("Roll amount is a non-number. Function: UAlberta.Maps.Interior.camera.rollCamera(amount)")}},setCameraRotationZ:function(e){if(!isNaN(e)){w.rZ=x.roundNumber(e,2)}else{t.error("Rotation amount is a non-number. Function: UAlberta.Maps.Interior.camera.rotateCamera(amount)")}},resetCamera:function(){w.centerCamera(true)},centerCamera:function(e){var t=u.length-1,n=0,r=0,i=0,a=0,f=0,l=0,c,h,p;w.offsetX=0;w.offsetY=0;w.offsetZ=500;w.rX=w.defaultCameraPitch;w.rZ=w.defaultCameraRotation;while(t){u[t].update();c=u[t].getBoundingBox();if(c.max.x>n){n=c.max.x}else if(c.min.x<a){a=c.min.x}if(c.max.y>r){r=c.max.y}else if(c.min.y<f){f=c.min.y}if(c.max.z>i){i=c.max.z}else if(c.min.z<l){l=c.min.z}t-=1}var d=500;if(n>s/2||a<s/2*-1){h=(n-s/2)/s+1;p=Math.abs((a+s/2)/s)+1;d=Math.floor(w.offsetZ+w.offsetZ*h+w.offsetZ*p);w.zoomBounds.zOut=d}w.offsetX=s/2;w.offsetY=o/2;if(e){R(x.roundNumber(2*Math.PI/3,3),d)}else{w.offsetZ=d;k()}},controlPanCameraY:function(e){w.panCameraY(e);k()},controlPanCameraX:function(e){w.panCameraX(e);k()},controlRotateCamera:function(e){w.rotateCamera(e);k()},controlZoomCamera:function(e){w.zoomCamera(e);k()}},E={downState:false,pos:[],actionPreformed:false,clickStartTime:null,prevClickEndTime:null,prevClickPos:[{x:0,y:0}],doubleClickInterval:200,doubleClickDistance:20,singleClickEvent:null,mouseDown:function(e){if(e.button==0){E.downState=true;E.pos=x.getEventXY(e);E.clickStartTime=(new Date).getTime()}},mouseUp:function(e){if(e.button==0&&E.pos.length>0){var t,n=(new Date).getTime(),r=Math.abs(E.prevClickPos[0].x-E.pos[0].x),i=Math.abs(E.prevClickPos[0].y-E.pos[0].y),s=!!(E.clickStartTime-E.prevClickEndTime<E.doubleClickInterval)&&Math.max(r,i)<E.doubleClickDistance;if(s){clearTimeout(E.singleClickEvent);E.singleClickEvent=null;E.actionPreformed=false;E.pos=[];E.prevClickEndTime=0}else{if(E.singleClickEvent==null){E.singleClickEvent=setTimeout(function(){if(!E.actionPreformed){for(t=0;t<u.length;t++){if(u[t].getType()==a.polygon){if(u[t].pointInPoly(E.pos[0])){u[t].extrudeEdges(50)}else{u[t].clearExtrusion()}}}UAlberta.Maps.Exterior.closeOpenWindows()}E.actionPreformed=false;E.pos=[];k();E.singleClickEvent=null},E.doubleClickInterval)}E.prevClickEndTime=n;E.prevClickPos=E.pos}E.downState=false}},mouseMove:function(e){var t=e.pageX-i.left,n=e.pageY-i.top,r,u;if(E.downState&&E.pos.length==1){r=E.pos[0];if(!e.shiftKey){u={x:e.pageX-r.offsetX,y:e.pageY-r.offsetY};w.setCameraPanX(u.x);w.setCameraPanY(u.y)}else{w.setCameraRotationX(((n-r.offsetY)/o*b-r.rX)%y);w.setCameraRotationZ((-((t-r.offsetX)/s-.5)*y-r.rZ)%y)}k();E.actionPreformed=true}},mouseWheel:function(e){e.preventDefault();t.event.fix(e);var n=0;if(e.wheelDelta){n=e.wheelDelta/120}if(e.detail){n=-e.detail/3}if(e.axis!==undefined&&e.axis===e.HORIZONTAL_AXIS){n=0}if(e.wheelDeltaY!==undefined){n=e.wheelDeltaY/120}w.zoomCamera(n*-10);k()},mouseHold:function(e,n,r,i,s){var o,u=i,a=function(){n(r);o=setTimeout(a,i);i=i/s};t("#"+e).mousedown(function(){a()}).bind("mouseup mouseleave",function(){clearTimeout(o);i=u})}},S={touchStateTypes:{none:0,drag:1,transform:2},transformStateTypes:{none:0,rotate:1,zoom:2,tilt:3},touchState:0,transformState:0,touchPos:[],lastDistance:0,firstTouch:false,actionPreformed:false,touchStartTime:null,prevTouchEndTime:null,prevTouchPos:[{x:0,y:0}],doubleTapInterval:200,doubleTapDistance:20,singleTouchEvent:null,touchStart:function(e){e.preventDefault();S.touchPos=x.getEventXY(e);if(e.touches.length==1){S.touchState=x.singleTouchInputMode();S.touchStartTime=(new Date).getTime()}else if(e.touches.length==2){S.touchState=S.touchStateTypes.transform;S.firstTouch=true}},touchEnd:function(e){e.preventDefault();if(e.touches.length==0&&S.touchPos.length>0){var t=Math.abs(S.prevTouchPos[0].x-S.touchPos[0].x),n=Math.abs(S.prevTouchPos[0].y-S.touchPos[0].y),r=!!(S.touchStartTime-S.prevTouchEndTime<S.doubleTapInterval)&&Math.max(t,n)<S.doubleTapDistance,i=(new Date).getTime(),s;if(r){clearTimeout(S.singleTouchEvent);S.actionPreformed=false;S.touchPos=[];S.prevTouchEndTime=0}else{S.singleTouchEvent=setTimeout(function(){if(!S.actionPreformed){for(s=0;s<u.length;s++){if(u[s].getType()==a.polygon){if(u[s].pointInPoly(S.touchPos[0])){u[s].extrudeEdges(50)}else{u[s].clearExtrusion()}}}UAlberta.Maps.Exterior.closeOpenWindows()}S.actionPreformed=false;S.touchPos=[];k()},S.doubleTapInterval);S.prevTouchEndTime=i;S.prevTouchPos=S.touchPos}S.touchState=S.touchStateTypes.none;S.lastDistance=0;S.transformState=S.transformStateTypes.none}else if(e.touches.length==1){S.downState=S.touchStateTypes.drag;S.lastDistance=0;S.touchPos=[];S.touchPos.push({x:e.touches[0].pageX,Y:e.touches[0].pageY,offsetX:e.touches[0].pageX-w.offsetX,offsetY:e.touches[0].pageY-w.offsetY})}},touchMove:function(e){e.preventDefault();var n=x.getEventXY(e),r=x.calculateFingerDistance(S.touchPos,n),i,u;if(S.touchState==S.touchStateTypes.transform&&e.touches.length==2){i=x.calculateFingerRotation(S.touchPos,n);u=x.calculateFingerScale(S.touchPos,n)*-10;if(Math.abs(i)>.25&&S.firstTouch||S.transformState==S.transformStateTypes.rotate){S.transformState=S.transformStateTypes.rotate;w.rotateCamera(i-S.lastDistance);S.lastDistance=i;S.firstTouch=false}else if(Math.abs(u)>25&&S.firstTouch||S.transformState==S.transformStateTypes.zoom){S.transformState=S.transformStateTypes.zoom;w.setCameraZoom(u+S.touchPos[0].offsetZ);S.firstTouch=false}else if(Math.abs(r.y)>30&&Math.abs(r.x)<30&&S.firstTouch||S.transformState==S.transformStateTypes.tilt){S.transformState=S.transformStateTypes.tilt;w.pitchCamera((r.y-S.lastDistance)/100);S.lastDistance=r.y;S.firstTouch=false}}else if(S.touchState==S.touchStateTypes.transform&&!h){if(t("input[name='touchType']:checked").val()=="zoom"){w.zoomCamera(r.y-S.lastDistance);S.lastDistance=r.y}else if(t("input[name='touchType']:checked").val()=="rotate"){var a=S.touchPos[0];w.setCameraRotationX(((n[0].y-a.offsetY)/o*b-a.rX)%y);w.setCameraRotationZ((-((n[0].x-a.offsetX)/s-.5)*y-a.rZ)%y)}}else{t("#mousePos").html("X: "+n[0].x+", Y: "+n[0].y);w.setCameraPanX(e.touches[0].pageX-S.touchPos[0].offsetX);w.setCameraPanY(e.touches[0].pageY-S.touchPos[0].offsetY)}k();S.actionPreformed=true}},x={startTimer:function(){l=new Date},roundNumber:function(e,t){var n=Math.pow(10,t);return Math.round(e*n)/n},getZIndex:function(e){var t=e.length,n=e.length,r=0;while(t--){r+=e[t]!=null?e[t].z:0}return x.roundNumber(r/n,2)},calcRotation:function(e){var t=Math.cos(w.rY),n=Math.sin(w.rY),r=Math.cos(w.rX),i=Math.sin(w.rX),s=Math.cos(w.rZ),o=Math.sin(w.rZ),u=e.z*s-e.x*o,a=e.y,f=e.z*o+e.x*s,l=a*r-f*i,c=a*i+f*r,h=u*t-l*n,p=u*n+l*t;return{x:h,y:p,z:c}},transform2D:function(e,t,n){var r=x.calcRotation({x:e,y:t,z:n});if(r.z>=-1*w.depth-w.offsetZ){var i=w.depth/(r.z+w.depth+w.offsetZ);if(isNaN(i)||!isFinite(i)){i=1}return{x:x.roundNumber(r.x*i+w.offsetX,2),y:x.roundNumber(r.y*i+w.offsetY,2),z:x.roundNumber(i+i*t,2)}}else{return null}},getEventXY:function(e){var t,n,r,u;if(c){var a=[];for(var f=0;f<e.touches.length;f++){t=e.touches[f].pageX-i.left;n=e.touches[f].pageY-i.top;r=e.touches[f].pageX-w.offsetX;u=e.touches[f].pageY-w.offsetY;a.push({x:t,y:n,offsetX:r,offsetY:u,offsetZ:w.offsetZ,rX:(n-u)/o*Math.PI/2-w.rX,rY:w.rY,rZ:-((t-r)/s-.5)*Math.PI*2-w.rZ})}return a}else{t=e.pageX-i.left;n=e.pageY-i.top;r=e.pageX-w.offsetX;u=e.pageY-w.offsetY;return[{x:t,y:n,offsetX:r,offsetY:u,offsetZ:w.offsetZ,rX:(n-u)/o*Math.PI/2-w.rX,rY:w.rY,rZ:-((t-r)/s-.5)*Math.PI*2-w.rZ}]}},calculateFingerRotation:function(e,t){if(e.length==2&&t.length==2){var n=e[0].x-e[1].x,r=e[0].y-e[1].y,i=Math.atan2(r,n);n=t[0].x-t[1].x;r=t[0].y-t[1].y;var s=Math.atan2(r,n);return s-i}return 0},calculateFingerScale:function(e,t){if(e.length==2&&t.length==2){var n=e[0].x-e[1].x,r=e[0].y-e[1].y,i=Math.sqrt(n*n+r*r);n=t[0].x-t[1].x;r=t[0].y-t[1].y;var s=Math.sqrt(n*n+r*r);return s-i}return 0},calculateFingerDistance:function(e,t){var n={x:0,y:0};if(e.length==t.length){for(var r=0;r<e.length;r++){n.x+=t[r].x-e[r].x;n.y+=t[r].y-e[r].y}n.x=n.x/e.length;n.y=n.y/e.length}return n},singleTouchInputMode:function(){if(!h){if(t("input[name='touchType']:checked").val()!="pan"){return S.touchStateTypes.transform}}return S.touchStateTypes.drag},rotateCompasPoint:function(e,t,n){var r={x:e.x-t.x,y:e.y-t.y};var i={x:r.x*Math.cos(n)-r.y*Math.sin(n),y:r.x*Math.sin(n)+r.y*Math.cos(n)};return{x:i.x+t.x,y:i.y+t.y}},renderCompass:function(){var e=w.rZ-b,t={x:s-10,y:45},r,i,o=30,u=25,a=10,f=16;if(g){o=o/1.5;u=u/1.5;a=a/1.5;f=f*1.5+10;t.y+=10}t.x=t.x-o*2;n.beginPath();n.arc(t.x,t.y,o,0,y,false);n.fillStyle="#FFFFFF";n.fill();n.lineWidth=3;n.strokeStyle="#606060";n.stroke();n.lineWidth=1;r=x.rotateCompasPoint({x:t.x,y:f},t,e);n.fillRect(r.x-6,r.y-6,12,12);n.strokeRect(r.x-6,r.y-6,12,12);n.fillStyle="#000000";n.font="bold 12px sans-serif";n.fillText("N",r.x-4,r.y+4,10);r=x.rotateCompasPoint({x:t.x,y:t.y-u},t,e);i=x.rotateCompasPoint({x:t.x+a,y:t.y},t,e);n.fillStyle="#044C02";n.beginPath();n.moveTo(t.x,t.y);n.lineTo(i.x,i.y);n.lineTo(r.x,r.y);n.fill();i=x.rotateCompasPoint({x:t.x-a,y:t.y},t,e);n.fillStyle="#007D43";n.beginPath();n.moveTo(t.x,t.y);n.lineTo(i.x,i.y);n.lineTo(r.x,r.y);n.fill();r=x.rotateCompasPoint({x:t.x,y:t.y+u},t,e);i=x.rotateCompasPoint({x:t.x+a,y:t.y},t,e);n.fillStyle="#808080";n.beginPath();n.moveTo(t.x,t.y);n.lineTo(i.x,i.y);n.lineTo(r.x,r.y);n.fill();i=x.rotateCompasPoint({x:t.x-a,y:t.y},t,e);n.fillStyle="#A0A0A0";n.beginPath();n.moveTo(t.x,t.y);n.lineTo(i.x,i.y);n.lineTo(r.x,r.y);n.fill()}},T={hostUrl:window.location.protocol+"//"+window.location.hostname+"/WebService/Maps/UWSDataService.asmx/GetInteriorData",timeout:3e4,toJSON:function(e){if(JSON.stringify){return'{ "parameters":'+JSON.stringify(e)+"}"}else{return'{ "parameters":'+t.toJSON(e)+"}"}},ajaxSuccess:function(e,n,r){if(!e&&!e.d){return}e=e.d;if(!e.__type&&e.__type!="UAlberta.WebService.Maps.Data.InteriorReturn"){return}var i;for(i=0;i<e.Polys.length;i++){B(e.Polys[i].Path,e.Polys[i].Triangles,e.Polys[i].Options)}for(i=0;i<e.Lines.length;i++){H(e.Lines[i].Start,e.Lines[i].End,e.Lines[i].Options)}for(i=0;i<e.Points.length;i++){P(e.Points[i].Point,e.Points[i].Options)}for(i=0;i<e.Text.length;i++){j(e.Text[i].Text,e.Text[i].Point,e.Text[i].Options)}for(i=0;i<e.Images.length;i++){F(e.Images[i].ImageURL,e.Images[i].TopLeft,e.Images[i].Width,e.Images[i].Height,e.Images[i].Options)}if(e.exteriorImage!=""){t(".leftNav_interior_buildingImage").html("<img src='"+e.exteriorImage+"' alt='Building Exterior Image' />")}UAlberta.Maps.Exterior.loadingBarToggle(false,n);w.centerCamera(r)},ajaxError:function(e){if(UAlberta.Maps.Exterior){UAlberta.Maps.Exterior.loadingBarToggle(false,e);UAlberta.Maps.Exterior.errorBarToggle();t("#leftNav_exit_btn").click()}}};return{initialise:N,isInitialised:f,updateInstance:C,render:k,clearCanvas:L,buildingKey:d,level:v,camera:{centerCamera:w.centerCamera,panCameraX:w.controlPanCameraX,panCameraY:w.controlPanCameraY,pitchCamera:w.pitchCamera,resetCamera:w.resetCamera,rotateCamera:w.controlRotateCamera,rollCamera:w.rollCamera,zoomCamera:w.controlZoomCamera},addPoint:P,addLine:H,addPolygon:B,addText:j,addImage:F,importBuildingData:I}}(UAlberta.Maps.Interior||{},jQuery)